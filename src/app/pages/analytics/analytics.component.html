<div class="analytics-dashboard">
  <!-- Header / Toolbar -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1>Analytics</h1>
      <p class="subtitle">Overview of your performance</p>
    </div>

    <div class="header-actions">
      <div class="time-selector">
        @for (days of [7, 30, 90, 365]; track days) {
          <button
            class="time-btn"
            [class.active]="currentDays() === days"
            (click)="setFilter(days)"
          >
            {{ days === 365 ? '1Y' : days + 'D' }}
          </button>
        }
      </div>

      <button
        class="icon-btn export-btn"
        (click)="exportCSV()"
        title="Export CSV"
        aria-label="Export CSV"
      >
        <i class="fas fa-download"></i>
      </button>
    </div>
  </header>

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner-border"></div>
      <span>Loading data...</span>
    </div>
  } @else {
    <div class="bento-grid">
      <!-- 1. Key Metrics Row -->
      <div class="metric-card card-plays">
        <div class="card-label"><i class="fas fa-play"></i> Plays</div>
        <div class="card-value">{{ data()?.total_plays | number }}</div>
      </div>

      <div class="metric-card card-revenue">
        <div class="card-label"><i class="fas fa-rupee-sign"></i> Revenue</div>
        <div class="card-value">
          {{ data()?.total_revenue | currency: 'INR' : 'symbol' : '1.0-0' }}
        </div>
      </div>

      <div class="metric-card card-favorites">
        <div class="card-label"><i class="fas fa-heart"></i> Favorites</div>
        <div class="card-value">{{ data()?.total_favorites | number }}</div>
      </div>

      <div class="metric-card card-downloads">
        <div class="card-label"><i class="fas fa-download"></i> Downloads</div>
        <div class="card-value">{{ data()?.total_downloads | number }}</div>
      </div>

      <!-- 2. Performance Chart (Plays vs Downloads) -->
      <div class="chart-card performance-section">
        <div class="card-header">
          <h3>Performance Trend</h3>
          <div class="legend-inline">
            <span class="legend-item plays"><span class="dot"></span> Plays</span>
            <span class="legend-item downloads"><span class="dot"></span> Downloads</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas
            baseChart
            [data]="lineChartData()"
            [options]="commonChartOptions"
            [type]="lineChartType"
          >
          </canvas>
        </div>
      </div>

      <!-- 3. Revenue Chart (Bar/Line) -->
      <div class="chart-card revenue-section">
        <div class="card-header floating-header">
          <h3>Revenue Trend</h3>
          <div class="glass-toggle">
            <button
              [class.active]="revenueChartType() === 'line'"
              (click)="revenueChartType.set('line')"
              title="Line View"
              aria-label="Toggle Line Chart"
            >
              <i class="fas fa-chart-line"></i>
            </button>
            <button
              [class.active]="revenueChartType() === 'bar'"
              (click)="revenueChartType.set('bar')"
              title="Bar View"
              aria-label="Toggle Bar Chart"
            >
              <i class="fas fa-chart-bar"></i>
            </button>
          </div>
        </div>
        <div class="chart-container full-bleed">
          <canvas
            baseChart
            [data]="revenueChartData()"
            [options]="revenueChartOptions"
            [type]="revenueChartType()"
          >
          </canvas>
        </div>
      </div>

      <!-- Bottom Row: License + Leaderboard -->
      <div class="bottom-grid">
        <!-- 4. License Distribution -->
        <div class="chart-card license-section">
          <div class="card-header">
            <h3>License Sales</h3>
          </div>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="doughnutChartData()"
              [options]="doughnutChartOptions"
              [type]="doughnutChartType"
            ></canvas>
            <div class="custom-legend">
              @for (label of doughnutChartData().labels; track label; let i = $index) {
                <div class="legend-row">
                  <span class="dot" [style.background-color]="getLegendColor(i)"></span>
                  <span class="label">{{ label }}</span>
                  <span class="value">{{ doughnutChartData().datasets[0].data[i] }}</span>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- 5. Top Tracks Leaderboard -->
        <div class="list-card leaderboard-section">
          <div class="card-header">
            <h3>Top Tracks</h3>
          </div>

          <div class="compact-list">
            <div class="list-head">
              <span class="col-rank">#</span>
              <span class="col-title">Track</span>

              <span
                class="col-sort"
                (click)="onSort('plays')"
                [class.active]="sortBy() === 'plays'"
              >
                Plays
                @if (sortBy() === 'plays') {
                  <i
                    class="fas"
                    [class.fa-caret-down]="sortDirection() === 'desc'"
                    [class.fa-caret-up]="sortDirection() === 'asc'"
                  ></i>
                }
              </span>

              <span
                class="col-sort"
                (click)="onSort('downloads')"
                [class.active]="sortBy() === 'downloads'"
              >
                Downloads
                @if (sortBy() === 'downloads') {
                  <i
                    class="fas"
                    [class.fa-caret-down]="sortDirection() === 'desc'"
                    [class.fa-caret-up]="sortDirection() === 'asc'"
                  ></i>
                }
              </span>

              <span
                class="col-sort text-right"
                (click)="onSort('revenue')"
                [class.active]="sortBy() === 'revenue'"
              >
                Revenue
                @if (sortBy() === 'revenue') {
                  <i
                    class="fas"
                    [class.fa-caret-down]="sortDirection() === 'desc'"
                    [class.fa-caret-up]="sortDirection() === 'asc'"
                  ></i>
                }
              </span>
            </div>

            @for (spec of topSpecs(); track spec.spec_id; let i = $index) {
              <div class="list-row" [class.top-3]="i < 3">
                <span class="col-rank" [attr.data-rank]="i + 1">{{ i + 1 }}</span>
                <span class="col-title text-truncate">
                  <i class="fas fa-music"></i> {{ spec.title }}
                </span>
                <span class="col-val">{{ spec.plays | number }}</span>
                <span class="col-val">{{ spec.downloads | number }}</span>
                <span class="col-val text-right brand-text">
                  {{ spec.revenue | currency: 'INR' : 'symbol' : '1.0-0' }}
                </span>
              </div>
            }
            @if (topSpecs().length === 0) {
              <div class="empty-row">No data</div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>
