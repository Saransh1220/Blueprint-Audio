<div class="analytics-container fade-in">
  <div class="header">
    <h1>Overview</h1>
    <div class="controls">
      <select class="time-selector" (change)="onFilterChange($event)">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 3 Months</option>
        <option value="365">This Year</option>
      </select>
      <button class="btn-export" (click)="exportCSV()">Export CSV</button>
    </div>
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading analytics...</p>
    </div>
  } @else {
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon red"><i class="fas fa-play"></i></div>
        <div class="details">
          <span class="label">Total Plays</span>
          <span class="value">{{ data()?.total_plays | number }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon blue"><i class="fas fa-heart"></i></div>
        <div class="details">
          <span class="label">Favorites</span>
          <span class="value">{{ data()?.total_favorites | number }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon green"><i class="fas fa-rupee-sign"></i></div>
        <div class="details">
          <span class="label">Revenue</span>
          <span class="value">{{ data()?.total_revenue | currency: 'INR' }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon purple"><i class="fas fa-download"></i></div>
        <div class="details">
          <span class="label">Downloads</span>
          <span class="value">{{ data()?.total_downloads | number }}</span>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-grid">
      <div class="chart-card glass-panel">
        <h3>Plays Over Time</h3>
        <div class="chart-container">
          <canvas
            baseChart
            [data]="lineChartData"
            [options]="lineChartOptions"
            [type]="lineChartType"
          >
          </canvas>
        </div>
      </div>
      <div class="chart-card glass-panel">
        <h3>Revenue by License</h3>
        <div class="chart-container">
          @if (doughnutChartData.datasets[0].data.length > 0) {
            <canvas baseChart [data]="doughnutChartData" [type]="doughnutChartType"> </canvas>
          } @else {
            <div class="empty-chart">No revenue data yet</div>
          }
        </div>
      </div>
    </div>

    <!-- Top Specs Table -->
    <div class="table-section glass-panel">
      <h3>Top Performing Specs</h3>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Plays</th>
              <th>Performance</th>
            </tr>
          </thead>
          <tbody>
            @for (spec of data()?.top_specs; track spec.spec_id) {
              <tr>
                <td>{{ spec.title }}</td>
                <td>{{ spec.plays | number }}</td>
                <td>
                  <div class="progress-bar">
                    <div
                      class="fill"
                      [style.width.%]="(spec.plays / (data()?.total_plays || 1)) * 100"
                    ></div>
                  </div>
                </td>
              </tr>
            }
            @if (!data()?.top_specs?.length) {
              <tr>
                <td colspan="3" class="text-center">No data available</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>
