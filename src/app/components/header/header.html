<nav>
  <div class="nav-inner">
    <div class="nav-brand" routerLink="/">
      <div class="brand-logo">
        <svg viewBox="0 0 100 100">
          <path
            d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            d="M20 50 L35 50 L45 25 L55 75 L65 50 L80 50"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
      <span class="desktop-logo">BLUEPRINT<span>AUDIO</span></span>
      <span class="mobile-logo">
        <span class="initial">B</span><span class="initial">P</span>
      </span>
    </div>
    <div class="nav-links">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
        >HOME</a
      >
      <a routerLink="/battles" routerLinkActive="active">BATTLES</a>
      @if (authService.currentUser()) {
        <a routerLink="/dashboard" routerLinkActive="active">DASHBOARD</a>
      }
    </div>

    <div class="header-actions">
      @if (authService.currentUser()?.role === Role.PRODUCER) {
        <a routerLink="/upload" class="upload-btn-cta">
          <i class="fas fa-cloud-upload-alt"></i> <span>UPLOAD</span>
        </a>
      }

      <button class="icon-btn cart-btn" (click)="cartClick.emit()">
        <i class="fas fa-shopping-cart"></i>
        @if (cartService.count() > 0) {
          <span class="cart-badge">{{ cartService.count() }}</span>
        }
      </button>

      @if (authService.currentUser()) {
        <div class="notification-wrap">
          <button
            class="icon-btn notification-btn"
            (click)="toggleNotifications()"
            [class.active]="isNotificationsOpen"
            aria-label="Notifications"
          >
            <i class="fas fa-bell"></i>
            @if (unreadCount() > 0) {
              <span class="notification-badge">{{ unreadCount() }}</span>
            }
          </button>

          @if (isNotificationsOpen) {
            <div class="dropdown-menu notifications-menu">
              <div class="menu-header">
                <span class="title">NOTIFICATIONS</span>
                @if (unreadCount() > 0) {
                  <button class="mark-read-btn" (click)="markAllAsRead()">Mark all read</button>
                }
              </div>
              <div class="notifications-list">
                @for (n of notifications(); track n.id) {
                  <button
                    type="button"
                    class="notification-item"
                    [class.unread]="!n.is_read"
                    (click)="markAsRead(n.id, $event)"
                  >
                    <div class="n-icon">
                      @if (n.type === 'processing_complete') {
                        <i class="fas fa-check-circle success"></i>
                      } @else if (n.type === 'processing_failed') {
                        <i class="fas fa-times-circle error"></i>
                      } @else {
                        <i class="fas fa-info-circle info"></i>
                      }
                    </div>
                    <div class="n-content">
                      <div class="n-title">{{ n.title }}</div>
                      <div class="n-message">{{ n.message }}</div>
                      <div class="n-time">{{ n.created_at | date: 'short' }}</div>
                    </div>
                    @if (!n.is_read) {
                      <div class="n-dot"></div>
                    }
                  </button>
                } @empty {
                  <div class="empty-state">
                    <i class="far fa-bell-slash"></i>
                    <span>No notifications</span>
                  </div>
                }
              </div>
            </div>
            <div class="backdrop" (click)="closeNotifications()"></div>
          }
        </div>
        <div class="user-menu-wrap">
          <button
            class="icon-btn user-btn"
            (click)="toggleUserMenu()"
            [class.active]="isUserMenuOpen"
          >
            @if (authService.currentUser()?.avatar_url) {
              <div
                class="user-avatar"
                [style.background-image]="'url(' + authService.currentUser()?.avatar_url + ')'"
              ></div>
            } @else {
              <div class="user-avatar-fallback">
                {{ authService.currentUser()?.name?.charAt(0) || 'U' }}
              </div>
            }
          </button>

          @if (isUserMenuOpen) {
            <div class="dropdown-menu">
              <a routerLink="/profile" (click)="closeUserMenu()" class="menu-item">
                <i class="fas fa-user"></i> PROFILE
              </a>
              <a
                [routerLink]="['/store', authService.currentUser()?.id]"
                (click)="closeUserMenu()"
                class="menu-item"
              >
                <i class="fas fa-store"></i> MY STORE
              </a>
              @if (authService.currentUser()?.role === Role.PRODUCER) {
                <a routerLink="/orders" (click)="closeUserMenu()" class="menu-item">
                  <i class="fas fa-file-invoice-dollar"></i> ORDERS
                </a>
              }
              <a routerLink="/settings" (click)="closeUserMenu()" class="menu-item">
                <i class="fas fa-cog"></i> SETTINGS
              </a>
              <a routerLink="/purchases" (click)="closeUserMenu()" class="menu-item">
                <i class="fas fa-music"></i> MY PURCHASES
              </a>
              <div class="menu-item theme-row">
                <span><i class="fas fa-adjust"></i> THEME</span>
                <app-theme-toggle></app-theme-toggle>
              </div>
              <button (click)="authService.logout(); closeUserMenu()" class="menu-item logout-item">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
              </button>
            </div>
            <div class="backdrop" (click)="closeUserMenu()"></div>
          }
        </div>
      } @else {
        <a routerLink="/login" class="login-btn">LOGIN</a>
        <app-theme-toggle class="desktop-theme-toggle"></app-theme-toggle>
      }

      <button class="hamburger-btn" (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </div>
</nav>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu" [class.open]="isMobileMenuOpen">
  <div class="mobile-logo-large">
    <svg viewBox="0 0 100 100">
      <path
        d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      />
      <path
        d="M20 50 L35 50 L45 25 L55 75 L65 50 L80 50"
        fill="none"
        stroke="currentColor"
        stroke-width="3"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </div>
  <div class="mobile-links">
    <a
      routerLink="/"
      routerLinkActive="active"
      [routerLinkActiveOptions]="{ exact: true }"
      (click)="closeMobileMenu()"
      >HOME</a
    >
    <a routerLink="/battles" routerLinkActive="active" (click)="closeMobileMenu()">BATTLES</a>
    <a routerLink="/settings" routerLinkActive="active" (click)="closeMobileMenu()">SETTINGS</a>
    @if (authService.currentUser()) {
      <a routerLink="/dashboard" routerLinkActive="active" (click)="closeMobileMenu()">DASHBOARD</a>
      <a routerLink="/profile" routerLinkActive="active" (click)="closeMobileMenu()">PROFILE</a>
      <a
        [routerLink]="['/store', authService.currentUser()?.id]"
        routerLinkActive="active"
        (click)="closeMobileMenu()"
        >MY STORE</a
      >
      <a routerLink="/purchases" routerLinkActive="active" (click)="closeMobileMenu()"
        >MY PURCHASES</a
      >
      <a (click)="authService.logout(); closeMobileMenu()" style="cursor: pointer">LOGOUT</a>
    } @else {
      <a routerLink="/login" (click)="closeMobileMenu()">LOGIN</a>
    }
  </div>

  <div class="mobile-menu-footer">
    <div class="theme-toggle-wrapper">
      <span>SWITCH THEME</span>
      <app-theme-toggle></app-theme-toggle>
    </div>
  </div>
</div>
