@if (isOpen()) {
  <div class="modal-overlay" (click)="close()">
    <div class="glass-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Refine Your Sound</h2>
        <button class="btn-close" (click)="close()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Image Upload Section -->
        <div class="image-upload-section">
          <div class="image-preview" [class.has-image]="imagePreview()">
            @if (imagePreview()) {
              <img [ngSrc]="imagePreview()!" alt="Cover Preview" fill priority />
            } @else {
              <div class="placeholder-icon">
                <i class="fas fa-image"></i>
              </div>
            }
            <div class="overlay">
              <label for="cover-upload" class="upload-btn">
                <i class="fas fa-camera"></i> Change Cover
              </label>
              <input
                id="cover-upload"
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                hidden
              />
            </div>
          </div>
          <div class="upload-tip">
            <small>Recommended: 1080x1080px (Square)</small>
          </div>
        </div>

        <!-- Form Section -->
        <form [formGroup]="editForm" class="spec-form">
          <div class="form-group">
            <label for="title">Title</label>
            <input
              id="title"
              type="text"
              formControlName="title"
              placeholder="Enter track title"
              class="glass-input"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bpm">BPM</label>
              <input
                id="bpm"
                type="number"
                formControlName="bpm"
                class="glass-input"
                placeholder="140"
              />
            </div>

            <div class="form-group">
              <label for="key">Key</label>
              <input
                id="key"
                type="text"
                formControlName="key"
                class="glass-input"
                placeholder="Cm"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="tags">Tags</label>
            <input
              id="tags"
              type="text"
              formControlName="tags"
              class="glass-input"
              placeholder="trap, dark, hard"
            />
            <small class="hint">Comma separated</small>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              id="description"
              formControlName="description"
              class="glass-input"
              rows="3"
              placeholder="Tell the story behind this beat..."
            ></textarea>
          </div>

          <div class="licenses-section">
            <h3>License Configuration</h3>

            <!-- Free MP3 Toggle (Enhanced) -->
            <div class="premium-toggle-container">
              <div class="toggle-info">
                <div class="icon-box">
                  <i class="fas fa-gift"></i>
                </div>
                <div class="toggle-text">
                  <span class="label-title">Free Download</span>
                  <span class="label-desc">Allow users to download MP3 for free</span>
                </div>
              </div>
              <label class="switch premium-switch">
                <input type="checkbox" formControlName="freeMp3Enabled" />
                <span class="slider round"></span>
              </label>
            </div>

            <div class="licenses-grid" formArrayName="licenses">
              @for (license of licenses.controls; track license; let i = $index) {
                <div
                  [formGroupName]="i"
                  class="license-card"
                  [class.disabled]="!license.get('enabled')?.value"
                >
                  <div class="lic-header">
                    <label class="switch">
                      <input type="checkbox" formControlName="enabled" />
                      <span class="slider round"></span>
                    </label>
                    <span class="lic-name">{{ license.get('name')?.value }}</span>
                  </div>

                  <div class="lic-body" [class.faded]="!license.get('enabled')?.value">
                    <div class="lic-price">
                      <i class="fas fa-rupee-sign"></i>
                      <input
                        type="number"
                        formControlName="price"
                        class="glass-input price-input"
                        placeholder="Price"
                      />
                    </div>
                    <ul class="lic-features">
                      @for (feat of license.get('features')?.value; track feat) {
                        <li><i class="fas fa-check"></i> {{ feat }}</li>
                      }
                    </ul>
                  </div>
                </div>
              }
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-text" (click)="close()" [disabled]="isSaving()">Cancel</button>
        <button class="btn-neon" (click)="save()" [disabled]="isSaving() || editForm.invalid">
          @if (isSaving()) {
            <span class="spinner-sm"></span> Saving...
          } @else {
            Save Changes
          }
        </button>
      </div>
    </div>
  </div>
}
